import { Control, EditorInterfaceProps } from 'contentful-management'
import { editorInterfacePatch } from './editor-interface-patch'
import { expect } from 'chai'
import { createEditorInterfaceFixture, createFieldControlFixture } from '@contentful/changeset-test-fixtures'
import { describe } from 'node:test'
import * as jsondiffpatch from '@contentful/jsondiffpatch'
import { createPatchedDocument } from '@contentful/changeset-utils'

function assertPatchResultCorrect(
  sourceEditorInterface: EditorInterfaceProps,
  targetEditorInterface: EditorInterfaceProps
): void {
  const patch = editorInterfacePatch({ sourceItem: sourceEditorInterface, targetItem: targetEditorInterface })

  const patchedTarget = createPatchedDocument(targetEditorInterface, patch)

  expect(patchedTarget).to.eql(sourceEditorInterface)
}

describe('An EditorInterface patch function', () => {
  describe('with same field controls, and same order', () => {
    it('creates a patch that resolves to identical target and source entities', () => {
      const sourceEditorInterface: EditorInterfaceProps = createEditorInterfaceFixture('default', [
        createFieldControlFixture('personalization'),
        createFieldControlFixture('style', { widgetId: 'entryLinkEditor', widgetNamespace: 'builtin' }),
      ])

      const targetEditorInterface: EditorInterfaceProps = createEditorInterfaceFixture('default', [
        createFieldControlFixture('personalization', { widgetId: 'objectEditor', widgetNamespace: 'builtin' }),
        createFieldControlFixture('style', { widgetId: 'entryLinkEditor', widgetNamespace: 'builtin' }),
      ])

      assertPatchResultCorrect(sourceEditorInterface, targetEditorInterface)
    })
  })
})

describe('jsondiffpatch library', () => {
  it('creates a delta that resolves in identical entities', () => {
    const sourceEditorInterface: EditorInterfaceProps = createEditorInterfaceFixture('default', [
      createFieldControlFixture('style', { widgetId: 'entryLinkEditor', widgetNamespace: 'builtin' }),
      createFieldControlFixture('personalization'),
    ])

    const targetEditorInterface: EditorInterfaceProps = createEditorInterfaceFixture('default', [
      createFieldControlFixture('personalization', { widgetId: 'objectEditor', widgetNamespace: 'builtin' }),
      createFieldControlFixture('style', { widgetId: 'entryLinkEditor', widgetNamespace: 'builtin' }),
    ])

    const differ = jsondiffpatch.create({
      arrays: {
        detectMove: false,
        includeValueOnMove: false,
      },
      textDiff: {
        minLength: Number.MAX_SAFE_INTEGER,
      },
      objectHash: function (obj: Control) {
        return obj.fieldId
      },
    })

    const delta = differ.diff(
      { controls: targetEditorInterface.controls },
      { controls: sourceEditorInterface.controls }
    )

    const patched = differ.patch(targetEditorInterface, delta!)
    expect(patched).to.eql(sourceEditorInterface)
  })
})
